<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Framework Info Static Site</title>
  </head>
  <body>
    <script src="../index.js"></script>
    <script>
      const repo = 'netlify-templates/gatsby-starter-netlify-cms'

      const get = async (path) => {
        const url = path ? `https://api.github.com/repos/${repo}/${path}` : `https://api.github.com/repos/${repo}`
        const response = await fetch(url)
        return response.json()
      }

      const listFiles = async () => {
        const { default_branch } = await get()
        const { tree } = await get(`git/trees/${default_branch}?recursive=1`)
        return tree.map(({ path }) => path)
      }

      const getPackageJson = async () => {
        const { content } = await get('contents/package.json')
        const raw = atob(content)
        return { packageJson: JSON.parse(raw), packageJsonPath: '' }
      }

      const getContext = async () => {
        const repoFiles = await listFiles()
        const locatePath = (paths) => {
          const foundPath = paths.find((path) => {
            const normalizedPath = path.startsWith('./') ? path.slice(2) : path
            return repoFiles.includes(normalizedPath)
          })
          return foundPath
        }
        return { projectDir: '.', locatePath, getPackageJson }
      }

      const getFrameworks = async () => {
        const context = await getContext()
        const frameworks = await frameworkInfo.listFrameworks(context)
        return frameworks
      }

      getFrameworks().then((frameworks) => {
        const body = document.getElementsByTagName('body')[0]
        frameworks.forEach((framework) => {
          const div = document.createElement('div')
          div.setAttribute('id', framework.name)
          div.innerText = JSON.stringify(framework)
          body.appendChild(div)
        })
      })
    </script>
  </body>
</html>
